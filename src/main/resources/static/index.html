<head>
    <style> body {
        margin: 0;
    } </style>

    <script src="js/d3-dsv.min.js"></script>
    <script src="js/index-array-by.min.js"></script>
    <script src="js/globe.gl.min.js"></script>
</head>

<body>
<div id="globeViz"></div>

<script>
    const COUNTRY = 'Estonia';
    const OPACITY = 1;

    const myGlobe = Globe()
    (document.getElementById('globeViz'))

        // .globeImageUrl('img/earth-night.jpg') // todo: night mode?
        .globeImageUrl('img/earth-blue-marble.jpg')
        // .pointOfView({lat: 59.4, lng: 24.8, altitude: 2}) // TLL
        .pointOfView({lat: 59.4, lng: 24.8, altitude: 0.1}) // TLL

        .arcLabel(d => `${d.srcIata} &#8594; ${d.dstIata}`)
        .arcStartLat(d => +d.srcAirport.lat)
        .arcStartLng(d => +d.srcAirport.lng)
        .arcEndLat(d => +d.dstAirport.lat)
        .arcEndLng(d => +d.dstAirport.lng)
        .arcDashLength(0.5)
        .arcDashGap(0.2)
        .arcDashInitialGap(() => Math.random())
        .arcDashAnimateTime(10000)
        .arcColor(d => [`rgba(0, 255, 0, ${OPACITY})`, `rgba(255, 0, 0, ${OPACITY})`])
        .arcsTransitionDuration(0)

        // .labelsData(places.features)
        .labelLat(d => d.lat)
        .labelLng(d => d.lon)
        .labelText(d => {
            return `${d.iataCode}`
        })
        // .labelText(d => `${d.iataCode.value} / ${d.icaoCode.value}`)
        // .labelText(d => 'xxx')
        .labelSize(0.05)
        .labelDotRadius(0.05)
        .labelColor(() => 'rgba(255, 165, 0, 0.75)')
        .labelResolution(2)

        // .pointColor(() => 'orange')
        // .pointAltitude(0)
        // .pointRadius(0.02);
        // .pointsMerge(true);

    const routeParse = ([airline, airlineId, srcIata, srcAirportId, dstIata, dstAirportId, codeshare, stops, equipment]) => ({
        airline,
        airlineId,
        srcIata,
        srcAirportId,
        dstIata,
        dstAirportId,
        codeshare,
        stops,
        equipment
    });

    Promise.all([
        fetch('airports').then(res => res.json())
            .then(d => d),
        fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat').then(res => res.text())
            .then(d => d3.csvParseRows(d, routeParse))
    ]).then(([airports, routes]) => {

        // const byIata = indexBy(airports, 'iata', false);
        //
        // const filteredRoutes = routes
        //     .filter(d => byIata.hasOwnProperty(d.srcIata) && byIata.hasOwnProperty(d.dstIata)) // exclude unknown airports
        //     .filter(d => d.stops === '0') // non-stop flights only
        //     .map(d => Object.assign(d, {
        //         srcAirport: byIata[d.srcIata],
        //         dstAirport: byIata[d.dstIata]
        //     }))
        //     .filter(d => d.srcAirport.country === COUNTRY && d.dstAirport.country !== COUNTRY); // international routes from country

        myGlobe
            .labelsData(airports);
            // .pointsData(airports)
            // .arcsData(filteredRoutes);
    });
</script>
</body>