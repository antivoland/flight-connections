<head>
    <style>
        body {
            margin: 0;
        }

        .search {
            position: absolute;
            width: 100%;
        }

        .select {
            width: 25%;
            float: left;
        }
    </style>

    <script type="text/javascript" src="js/d3-dsv.min.js"></script>
    <script type="text/javascript" src="js/index-array-by.min.js"></script>
    <script type="text/javascript" src="js/globe.gl.min.js"></script>
    <script type="text/javascript" src="js/jquery-3.7.0.min.js"></script>
    <script type="text/javascript" src="js/selectize.min.js"></script>

    <link rel="stylesheet" href="css/selectize.default.css">
</head>

<body>
<div class="search">
    <select id="src" class="select" style="width: 25%" placeholder="Select SRC code..."></select>
    <select id="dst" class="select" placeholder="Select DST code..."></select>
    <select id="theme" class="select">
        <option value="dark">Dark</option>
        <option value="light selected">Light</option>
    </select>
    <select id="limit" class="select">
        <option value="unlimited" selected>Unlimited</option>
        <option value="limited">Limited to 4 flights maximum</option>
    </select>
</div>
<div id="globeViz"></div>

<script>
    let srcCode = null, dstCode = null, limited = false, route = null;

    const update = () => {
        if (srcCode != null && dstCode != null) {
            fetch(`route?srcCode=${srcCode}&dstCode=${dstCode}&limited=${limited}`)
                .then(response => response.json())
                .then(r => {
                    route = r;
                    redraw();
                });
        } else {
            route = null;
        }
        redraw();
    };

    const codeMapper = {};
    const globe = Globe()($('#globeViz')[0])
        .globeImageUrl('img/earth-night.jpg')
        .pointOfView({lat: 59.4, lng: 24.8, altitude: 2})

        .arcLabel(move => {
            const codes = function (spot) {
                return spot.codes
                    .sort((a, b) => a.value.length - b.value.length)
                    .map(code => `${code.type}:${code.value}`)
            }
            const kmDistance = function (move) {
                return Math.round(move.kmDistance * 100) / 100
            }
            return move.type === 'BY_AIR'
                ? `(${codes(move.src)})-[${kmDistance(move)}km]->(${codes(move.dst)})`
                : `(${codes(move.src)})=[${kmDistance(move)}km]=>(${codes(move.dst)})`;
        })
        .arcStartLat(move => +move.src.lat)
        .arcStartLng(move => +move.src.lon)
        .arcEndLat(move => +move.dst.lat)
        .arcEndLng(move => +move.dst.lon)
        .arcDashLength(0.1)
        .arcDashGap(0.1)
        .arcStroke(move => move.type === 'BY_AIR' ? 0.2 : 0.3)
        .arcDashAnimateTime(5000)
        .arcColor(move => move.type === 'BY_AIR' ? `rgba(0, 255, 0, 1)` : `rgba(255, 0, 0, 1)`)
        .arcsTransitionDuration(0)

        .labelLat(spot => spot.lat)
        .labelLng(spot => spot.lon)
        .labelText(spot => spot.val)
        .labelSize(0.4)
        .labelDotRadius(0.1)
        .labelColor(() => 'rgba(255, 165, 0, 0.75)')
        .labelsTransitionDuration(0)

        .ringColor(() => t => `rgba(255,100,50,${Math.sqrt(1 - t)})`)
        .ringMaxRadius(20)
        .ringPropagationSpeed(10)
        .ringRepeatPeriod(2000)

    $('#theme').selectize({
        onChange: value => globe.globeImageUrl(value === 'dark'
            ? 'img/earth-night.jpg'
            : 'img/earth-blue-marble.jpg'),
        onDelete: () => false
    });
    $('#theme-selectized').attr('readonly', 'readonly');
    $('#limit').selectize({
        onChange: value => {
            limited = value === 'limited';
            update();
        },
        onDelete: () => false
    });
    $('#limit-selectized').attr('readonly', 'readonly');
    // todo: hand cursor

    const degreesToRadians = degrees => degrees * Math.PI / 180;

    const radiansToDegrees = radians => radians * (180 / Math.PI);

    const midpoint = (lat1, lon1, lat2, lon2) => {
        let dLon = degreesToRadians(lon2 - lon1);

        //convert to radians
        lat1 = degreesToRadians(lat1);
        lat2 = degreesToRadians(lat2);
        lon1 = degreesToRadians(lon1);

        let Bx = Math.cos(lat2) * Math.cos(dLon);
        let By = Math.cos(lat2) * Math.sin(dLon);
        let lat3 = Math.atan2(Math.sin(lat1) + Math.sin(lat2), Math.sqrt((Math.cos(lat1) + Bx) * (Math.cos(lat1) + Bx) + By * By));
        let lon3 = lon1 + Math.atan2(By, Math.cos(lat1) + Bx);
        return {lat: radiansToDegrees(lat3), lon: radiansToDegrees(lon3)};
    };

    const middlePoint = function (lat1, lng1, lat2, lng2) {

        //-- Longitude difference
        var dLng = degreesToRadians(lng2 - lng1);

        //-- Convert to radians
        lat1 = degreesToRadians(lat1);
        lat2 = degreesToRadians(lat2);
        lng1 = degreesToRadians(lng1);

        var bX = Math.cos(lat2) * Math.cos(dLng);
        var bY = Math.cos(lat2) * Math.sin(dLng);
        var lat3 = Math.atan2(Math.sin(lat1) + Math.sin(lat2), Math.sqrt((Math.cos(lat1) + bX) * (Math.cos(lat1) + bX) + bY * bY));
        var lng3 = lng1 + Math.atan2(bY, Math.cos(lat1) + bX);

        //-- Return result
        return {lat: radiansToDegrees(lat3), lon: radiansToDegrees(lng3)};
    }

    const redraw = () => {
        const src = srcCode != null ? codeMapper[srcCode] : null;
        const dst = dstCode != null ? codeMapper[dstCode] : null;

        const labels = [];
        const moves = [];
        const rings = [];
        let cameraLat, cameraLon, cameraAlt;

        if (srcCode != null && dstCode != null) {
            labels.push({lat: src.lat, lon: src.lon, val: srcCode})
            if (route != null) {
                for (let idx = 1; idx < route.moves.length; ++idx) {
                    const move = route.moves[idx];
                    labels.push({lat: move.src.lat, lon: move.src.lon, val: ""})
                }
                moves.push(...route.moves);
            }
            labels.push({lat: dst.lat, lon: dst.lon, val: dstCode})

            const midpoin = middlePoint(src.lat, src.lon, dst.lat, dst.lon);
            rings.push({lat: midpoin.lat, lng: midpoin.lon})

            cameraLat = midpoin.lat;
            cameraLon = midpoin.lon;
            cameraAlt = 2;
        } else if (srcCode != null) {
            labels.push({lat: src.lat, lon: src.lon, val: srcCode})
            cameraLat = src.lat;
            cameraLon = src.lon;
            cameraAlt = 0.5;
        } else if (dstCode != null) {
            labels.push({lat: dst.lat, lon: dst.lon, val: dstCode})
            cameraLat = dst.lat;
            cameraLon = dst.lon;
            cameraAlt = 0.5;
        } else {
            cameraLat = 59.4
            cameraLon = 24.8;
            cameraAlt = 2;
        }

        globe.labelsData(labels);
        globe.arcsData(moves)
        globe.ringsData(rings);

        globe.pointOfView({lat: cameraLat, lon: cameraLon, altitude: cameraAlt}, 2000);
    }

    fetch('airports')
        .then(response => response.json())
        .then(airports => {
            for (const airport of airports) {
                if (airport.iataCode != null) codeMapper[airport.iataCode.value] = airport;
                if (airport.icaoCode != null) codeMapper[airport.icaoCode.value] = airport;
            }
            const selectOptions = airports.flatMap(airport => {
                const airportCodes = [];
                if (airport.iataCode != null) airportCodes.push({
                    type: 'IATA',
                    value: airport.iataCode.value,
                    name: airport.iataCode.value + ' (' + airport.name + ')'
                })
                if (airport.icaoCode != null) airportCodes.push({
                    type: 'ICAO',
                    value: airport.icaoCode.value,
                    name: airport.icaoCode.value + ' (' + airport.name + ')'
                })
                return airportCodes
            })
            for (const sel of ['#src', '#dst']) {
                $(sel).selectize({
                    options: selectOptions,
                    optionGroupRegister: function (optgroup) {
                        const group = {};
                        group['label'] = optgroup;
                        group[this.settings.optgroupValueField] = optgroup;
                        return group;
                    },
                    optgroupField: 'type',
                    labelField: 'name',
                    searchField: ['name'],
                    sortField: 'name',
                    onChange: code => {
                        if (sel === '#src') srcCode = code ? code : null;
                        else dstCode = code ? code : null;
                        update();
                    }
                });
            }
        });
</script>
</body>