<head>
    <style>
        body {
            margin: 0;
        }

        .search {
            position: absolute;
            width: 100%;
        }

        .code {
            width: 50%;
            float: left;
        }
    </style>

    <script type="text/javascript" src="js/d3-dsv.min.js"></script>
    <script type="text/javascript" src="js/index-array-by.min.js"></script>
    <script type="text/javascript" src="js/globe.gl.min.js"></script>
    <script type="text/javascript" src="js/jquery-3.7.0.min.js"></script>
    <script type="text/javascript" src="js/selectize.min.js"></script>

    <link rel="stylesheet" href="css/selectize.default.css">
</head>

<body>
<div class="search">
    <select id="src" class="code" placeholder="Select SRC code..."></select>
    <select id="dst" class="code" placeholder="Select DST code..."></select>
</div>
<div id="globeViz"></div>

<script>
    var srcCode = null, dstCode = null;
    const globe = Globe()($('#globeViz')[0])
        // .globeImageUrl('img/earth-night.jpg') // todo: night mode?
        .globeImageUrl('img/earth-blue-marble.jpg')
        .pointOfView({lat: 59.4, lng: 24.8, altitude: 2})

        .arcLabel(d => `${d.srcIata} &#8594; ${d.dstIata}`)
        .arcStartLat(d => +d.srcAirport.lat)
        .arcStartLng(d => +d.srcAirport.lng)
        .arcEndLat(d => +d.dstAirport.lat)
        .arcEndLng(d => +d.dstAirport.lng)
        .arcDashLength(0.5)
        .arcDashGap(0.2)
        .arcDashInitialGap(() => Math.random())
        .arcDashAnimateTime(10000)
        .arcColor(d => [`rgba(0, 255, 0, 1)`, `rgba(255, 0, 0, 1)`])
        .arcsTransitionDuration(0)

        // .labelsData(places.features)
        .labelLat(d => d.lat)
        .labelLng(d => d.lon)
        .labelText(d => d.val)
        // .labelText(d => `${d.iataCode.value} / ${d.icaoCode.value}`)
        // .labelText(d => 'xxx')
        .labelSize(1)
        .labelDotRadius(0.3)
        .labelColor(() => 'rgba(255, 165, 0, 0.75)')
        .labelResolution(2)
        .labelsTransitionDuration(0)

        .ringColor(() => t => `rgba(255,100,50,${Math.sqrt(1 - t)})`)
        .ringMaxRadius(5)
        .ringPropagationSpeed(10)
        .ringRepeatPeriod(2000)

    fetch('airports')
        .then(response => response.json())
        .then(airports => {
            const codeMapper = {};
            for (const airport of airports) {
                if (airport.iataCode != null) codeMapper[airport.iataCode.value] = airport;
                if (airport.icaoCode != null) codeMapper[airport.icaoCode.value] = airport;
            }
            const selectOptions = airports.flatMap(airport => {
                const airportCodes = [];
                if (airport.iataCode != null) airportCodes.push({
                    type: 'IATA',
                    value: airport.iataCode.value,
                    name: airport.iataCode.value + ' (lat=' + airport.lat + ', lon=' + airport.lon + ')'
                })
                if (airport.icaoCode != null) airportCodes.push({
                    type: 'ICAO',
                    value: airport.icaoCode.value,
                    name: airport.icaoCode.value + ' (lat=' + airport.lat + ', lon=' + airport.lon + ')'
                })
                return airportCodes
            })
            for (const sel of ['#src', '#dst']) {
                $(sel).selectize({
                    options: selectOptions,
                    optionGroupRegister: function (optgroup) {
                        const group = {};
                        group['label'] = optgroup;
                        group[this.settings.optgroupValueField] = optgroup;
                        return group;
                    },
                    optgroupField: 'type',
                    labelField: 'name',
                    searchField: ['name'],
                    sortField: 'name',
                    onChange: code => {
                        if (sel === '#src') srcCode = code ? code : null;
                        else dstCode = code ? code : null;

                        const src = srcCode != null ? codeMapper[srcCode] : null;
                        const dst = dstCode != null ? codeMapper[dstCode] : null;

                        const labels = [];
                        const rings = [];
                        if (src != null) {
                            labels.push({lat: src.lat, lon: src.lon, val: srcCode})
                            rings.push({lat: src.lat, lng: src.lon})
                        }
                        if (dst != null) {
                            labels.push({lat: dst.lat, lon: dst.lon, val: dstCode})
                            rings.push({lat: dst.lat, lng: dst.lon})
                        }

                        globe.labelsData(labels);
                        globe.ringsData(rings);

                        if (srcCode != null && dstCode != null) {

                        } else if (srcCode != null) {
                            globe.pointOfView({lat: src.lat, lng: src.lon, altitude: 1}, 2000);
                        } else {
                            globe.pointOfView({lat: dst.lat, lng: dst.lon, altitude: 1}, 2000);
                        }
                    }
                });
            }
        });


    const routeParse = ([airline, airlineId, srcIata, srcAirportId, dstIata, dstAirportId, codeshare, stops, equipment]) => ({
        airline,
        airlineId,
        srcIata,
        srcAirportId,
        dstIata,
        dstAirportId,
        codeshare,
        stops,
        equipment
    });

    // Promise.all([
    //     fetch('airports').then(res => res.json())
    //         .then(d => d),
    //     fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat').then(res => res.text())
    //         .then(d => d3.csvParseRows(d, routeParse))
    // ]).then(([airports, routes]) => {
    //
    //     // const byIata = indexBy(airports, 'iata', false);
    //     //
    //     // const filteredRoutes = routes
    //     //     .filter(d => byIata.hasOwnProperty(d.srcIata) && byIata.hasOwnProperty(d.dstIata)) // exclude unknown airports
    //     //     .filter(d => d.stops === '0') // non-stop flights only
    //     //     .map(d => Object.assign(d, {
    //     //         srcAirport: byIata[d.srcIata],
    //     //         dstAirport: byIata[d.dstIata]
    //     //     }))
    //     //     .filter(d => d.srcAirport.country === COUNTRY && d.dstAirport.country !== COUNTRY); // international routes from country
    //
    //     myGlobe
    //         .labelsData(airports);
    //     // .pointsData(airports)
    //     // .arcsData(filteredRoutes);
    // });
</script>
</body>