<head>
    <style>
        body {
            margin: 0;
        }

        .search {
            position: absolute;
            width: 100%;
        }

        .select {
            width: 25%;
            float: left;
        }
    </style>

    <script type="text/javascript" src="js/d3-dsv.min.js"></script>
    <script type="text/javascript" src="js/index-array-by.min.js"></script>
    <script type="text/javascript" src="js/globe.gl.min.js"></script>
    <script type="text/javascript" src="js/jquery-3.7.0.min.js"></script>
    <script type="text/javascript" src="js/selectize.min.js"></script>

    <link rel="stylesheet" href="css/selectize.default.css">
</head>

<body>
<div class="search">
    <select id="src" class="select" style="width: 25%" placeholder="Select SRC code..."></select>
    <select id="dst" class="select" placeholder="Select DST code..."></select>
    <select id="theme" class="select">
        <option value="dark">Dark</option>
        <option value="light selected">Light</option>
    </select>
    <select id="limit" class="select">
        <option value="unlimited" selected>Unlimited</option>
        <option value="limited">Limited to 4 flights maximum</option>
    </select>
</div>
<div id="globeViz"></div>

<script>
    let srcCode = null, dstCode = null, limited = false;
    const codeMapper = {};
    const globe = Globe()($('#globeViz')[0])
        .globeImageUrl('img/earth-night.jpg')
        .pointOfView({lat: 59.4, lng: 24.8, altitude: 2})

        .arcLabel(move => {
            const codes = function (spot) {
                return spot.codes
                    .sort((a, b) => a.value.length - b.value.length)
                    .map(code => `${code.type}:${code.value}`)
            }
            const kmDistance = function (move) {
                return Math.round(move.kmDistance * 100) / 100
            }
            return move.type === 'BY_AIR'
                ? `(${codes(move.src)})-[${kmDistance(move)}km]->(${codes(move.dst)})`
                : `(${codes(move.src)})=[${kmDistance(move)}km]=>(${codes(move.dst)})`;
        })
        .arcStartLat(move => +move.src.lat)
        .arcStartLng(move => +move.src.lon)
        .arcEndLat(move => +move.dst.lat)
        .arcEndLng(move => +move.dst.lon)
        .arcDashLength(0.1)
        .arcDashGap(0.1)
        .arcStroke(move => move.type === 'BY_AIR' ? 0.2 : 0.3)
        .arcDashAnimateTime(5000)
        .arcColor(move => move.type === 'BY_AIR' ? `rgba(0, 255, 0, 1)` : `rgba(255, 0, 0, 1)`)
        .arcsTransitionDuration(0)

        .labelLat(spot => spot.lat)
        .labelLng(spot => spot.lon)
        .labelText(spot => spot.val)
        .labelSize(0.4)
        .labelDotRadius(0.1)
        .labelColor(() => 'rgba(255, 165, 0, 0.75)')
        .labelsTransitionDuration(0)

        .ringColor(() => t => `rgba(255,100,50,${Math.sqrt(1 - t)})`)
        .ringMaxRadius(5)
        .ringPropagationSpeed(10)
        .ringRepeatPeriod(2000)

    $('#theme').selectize({
        onChange: value => globe.globeImageUrl(value === 'dark'
            ? 'img/earth-night.jpg'
            : 'img/earth-blue-marble.jpg'),
        onDelete: () => false
    });
    $('#theme-selectized').attr('readonly', 'readonly');
    $('#limit').selectize({
        onChange: value => {
            limited = value === 'limited';
            update();
        },
        onDelete: () => false
    });
    $('#limit-selectized').attr('readonly', 'readonly');
    // todo: hand cursor

    const update = function () {
        const src = srcCode != null ? codeMapper[srcCode] : null;
        const dst = dstCode != null ? codeMapper[dstCode] : null;

        const labels = [];
        if (src != null) {
            labels.push({lat: src.lat, lon: src.lon, val: srcCode})
        }
        if (dst != null) {
            labels.push({lat: dst.lat, lon: dst.lon, val: dstCode})
        }

        globe.labelsData(labels);
        globe.arcsData([])

        if (srcCode != null && dstCode != null) {
            fetch(`route?srcCode=${srcCode}&dstCode=${dstCode}&limited=${limited}`)
                .then(response => response.json())
                .then(route => {
                    globe.arcsData(route.moves)
                    const labels = [];
                    labels.push({lat: src.lat, lon: src.lon, val: srcCode})
                    for (let idx = 1; idx < route.moves.length; ++idx) {
                        const move = route.moves[idx];
                        labels.push({lat: move.src.lat, lon: move.src.lon, val: ""})
                    }
                    labels.push({lat: dst.lat, lon: dst.lon, val: dstCode})
                    globe.labelsData(labels);
                    globe.pointOfView({altitude: 1}, 2000); // todo: midpoint
                })
        } else if (srcCode != null) {
            globe.pointOfView({lat: src.lat, lng: src.lon, altitude: 0.5}, 2000);
        } else {
            globe.pointOfView({lat: dst.lat, lng: dst.lon, altitude: 0.5}, 2000);
        }
    }

    fetch('airports')
        .then(response => response.json())
        .then(airports => {
            for (const airport of airports) {
                if (airport.iataCode != null) codeMapper[airport.iataCode.value] = airport;
                if (airport.icaoCode != null) codeMapper[airport.icaoCode.value] = airport;
            }
            const selectOptions = airports.flatMap(airport => {
                const airportCodes = [];
                if (airport.iataCode != null) airportCodes.push({
                    type: 'IATA',
                    value: airport.iataCode.value,
                    name: airport.iataCode.value + ' (' + airport.name + ')'
                })
                if (airport.icaoCode != null) airportCodes.push({
                    type: 'ICAO',
                    value: airport.icaoCode.value,
                    name: airport.icaoCode.value + ' (' + airport.name + ')'
                })
                return airportCodes
            })
            for (const sel of ['#src', '#dst']) {
                $(sel).selectize({
                    options: selectOptions,
                    optionGroupRegister: function (optgroup) {
                        const group = {};
                        group['label'] = optgroup;
                        group[this.settings.optgroupValueField] = optgroup;
                        return group;
                    },
                    optgroupField: 'type',
                    labelField: 'name',
                    searchField: ['name'],
                    sortField: 'name',
                    onChange: code => {
                        if (sel === '#src') srcCode = code ? code : null;
                        else dstCode = code ? code : null;
                        update();
                    }
                });
            }
        });
</script>
</body>